#!/bin/bash
# Bot management script for Iris - Executive Assistant

BOT_DIR="/home/executive-assistant"
PID_FILE="/tmp/iris-bot.pid"
LOG_FILE="/tmp/iris-bot.log"
VENV_DIR="$BOT_DIR/venv"

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

case "$1" in
    start)
        if [ -f "$PID_FILE" ] && kill -0 $(cat "$PID_FILE") 2>/dev/null; then
            echo -e "${YELLOW}Bot already running (PID: $(cat $PID_FILE))${NC}"
            exit 1
        fi

        cd "$BOT_DIR"

        # Create venv if it doesn't exist
        if [ ! -d "$VENV_DIR" ]; then
            echo -e "${YELLOW}Creating virtual environment...${NC}"
            python3 -m venv "$VENV_DIR"
            source "$VENV_DIR/bin/activate"
            pip install -r requirements.txt
        else
            source "$VENV_DIR/bin/activate"
        fi

        # Load environment variables
        if [ -f "$BOT_DIR/.env" ]; then
            export $(grep -v '^#' "$BOT_DIR/.env" | xargs)
        fi

        # Start bot in background
        nohup python bot.py >> "$LOG_FILE" 2>&1 &
        echo $! > "$PID_FILE"

        sleep 2
        if kill -0 $(cat "$PID_FILE") 2>/dev/null; then
            echo -e "${GREEN}Bot started (PID: $(cat $PID_FILE))${NC}"
        else
            echo -e "${RED}Bot failed to start. Check logs: $LOG_FILE${NC}"
            rm -f "$PID_FILE"
            exit 1
        fi
        ;;

    stop)
        if [ -f "$PID_FILE" ]; then
            PID=$(cat "$PID_FILE")
            if kill -0 "$PID" 2>/dev/null; then
                kill "$PID"
                sleep 2
                if kill -0 "$PID" 2>/dev/null; then
                    kill -9 "$PID"
                fi
                echo -e "${GREEN}Bot stopped${NC}"
            else
                echo -e "${YELLOW}Bot was not running${NC}"
            fi
            rm -f "$PID_FILE"
        else
            echo -e "${YELLOW}No PID file found${NC}"
        fi
        ;;

    restart)
        $0 stop
        sleep 2
        $0 start
        ;;

    status)
        if [ -f "$PID_FILE" ] && kill -0 $(cat "$PID_FILE") 2>/dev/null; then
            echo -e "${GREEN}Running (PID: $(cat $PID_FILE))${NC}"

            # Show memory usage
            PID=$(cat "$PID_FILE")
            MEM=$(ps -o rss= -p $PID 2>/dev/null | awk '{print int($1/1024)"MB"}')
            echo -e "Memory: $MEM"

            # Show uptime
            STARTED=$(ps -o lstart= -p $PID 2>/dev/null)
            echo -e "Started: $STARTED"
        else
            echo -e "${RED}Not running${NC}"
            exit 1
        fi
        ;;

    logs)
        if [ -f "$LOG_FILE" ]; then
            tail -f "$LOG_FILE"
        else
            echo -e "${YELLOW}No log file found${NC}"
        fi
        ;;

    setup)
        echo -e "${YELLOW}Setting up Executive Assistant bot...${NC}"
        cd "$BOT_DIR"

        # Create venv
        python3 -m venv "$VENV_DIR"
        source "$VENV_DIR/bin/activate"

        # Install dependencies
        pip install -r requirements.txt

        echo -e "${GREEN}Setup complete!${NC}"
        echo ""
        echo "Next steps:"
        echo "1. Edit .env with your Discord token and other credentials"
        echo "2. Run: ./botctl start"
        ;;

    *)
        echo "Iris - Executive Assistant Bot"
        echo ""
        echo "Usage: botctl {start|stop|restart|status|logs|setup}"
        echo ""
        echo "Commands:"
        echo "  start   - Start Iris"
        echo "  stop    - Stop Iris"
        echo "  restart - Restart Iris"
        echo "  status  - Check if Iris is running"
        echo "  logs    - Tail the log file"
        echo "  setup   - First-time setup (create venv, install deps)"
        ;;
esac
